<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; }
    .wrap { max-width:800px; margin:10px auto; padding:10px; }
    h1 { font-size:18px; margin:0 0 10px }
    #messages { height:360px; overflow:auto; border:1px solid #ccc; padding:6px; background:#fafafa; }
    .msg { margin:6px 0; padding:6px; border-radius:4px; background:#fff; border:1px solid #ddd; }
    .meta { font-size:11px; color:#666; margin-bottom:4px; }
    form { display:flex; gap:6px; margin-top:8px; }
    input[type=text] { flex:1; padding:8px; font-size:14px; }
    button { padding:8px 12px; }
    .small { font-size:12px; color:#666; margin-top:10px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>–ü—Ä–æ—Å—Ç–æ–π –ß–∞—Ç</h1>
  <div id="messages">–ó–¥–µ—Å—å –±—É–¥—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...</div>

  <form id="sendForm">
    <input id="nick" type="text" placeholder="–í–∞—à –Ω–∏–∫" />
    <input id="text" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" />
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <div class="small">–≠—Ç–æ—Ç —á–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Firebase Realtime Database</div>
</div>

<script>
  // üëâ –¢–í–û–ô –†–ï–ê–õ–¨–ù–´–ô –ö–û–ù–§–ò–ì
  var FIREBASE_CONFIG = {
    apiKey: "AIzaSyCT731vBnsJXOrpVhG84hLU1BDIsFMvV5c",
    authDomain: "viar-chat.firebaseapp.com",
    databaseURL: "https://viar-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "viar-chat",
    storageBucket: "viar-chat.appspot.com",
    messagingSenderId: "1012733064511",
    appId: "1:1012733064511:web:d4f2645202ff5586910f8a"
  };

  // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º SDK v8 (–Ω—É–∂–Ω–æ –î–í–ê —Å–∫—Ä–∏–ø—Ç–∞: app –∏ database)
  (function loadFirebase(){
    var s1 = document.createElement('script');
    s1.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js';
    s1.onload = function(){
      var s2 = document.createElement('script');
      s2.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js';
      s2.onload = init;
      document.head.appendChild(s2);
    };
    document.head.appendChild(s1);
  })();

  function init(){
    try{
      firebase.initializeApp(FIREBASE_CONFIG);
      var db = firebase.database();
      var messagesRef = db.ref('chat/messages');

      var messagesEl = document.getElementById('messages');
      var nickInp = document.getElementById('nick');
      var textInp = document.getElementById('text');
      var form = document.getElementById('sendForm');

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å–æ–æ–±—â–µ–Ω–∏–π
      messagesRef.limitToLast(200).on('child_added', function(snapshot){
        var m = snapshot.val() || {};
        var el = document.createElement('div');
        el.className = 'msg';
        el.innerHTML =
          '<div class="meta">'+escapeHtml(m.nick || "–ë–µ–∑ –∏–º–µ–Ω–∏")+'</div>'+
          '<div class="text">'+escapeHtml(m.text || "")+'</div>';
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, function(err){
        showError(err);
      });

      // –æ—Ç–ø—Ä–∞–≤–∫–∞
      form.addEventListener('submit', function(e){
        e.preventDefault();
        var nick = (nickInp.value || '').trim() || '–ê–Ω–æ–Ω–∏–º';
        var text = (textInp.value || '').trim();
        if(!text) return;
        messagesRef.push({nick:nick, text:text})
          .catch(showError);
        textInp.value = '';
      });

    }catch(err){
      showError(err);
    }
  }

  function showError(err){
    console.error(err);
    var el = document.getElementById('messages');
    el.innerHTML = '–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : err);
  }

  function escapeHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
</script>
</body>
</html>
